# X Certbot - 系统架构

## 系统概述

X Certbot 是一个基于 Docker 的自动化解决方案，用于通过 Let's Encrypt 获取和管理 SSL/TLS 证书。它支持多种云服务提供商（目前包括阿里云和腾讯云）和多种验证方式（DNS-01 和 HTTP-01），使用插件化架构实现灵活扩展，并提供高度可定制的部署选项。系统自动管理证书的申请、验证、续期和部署全过程。

## 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                     X Certbot 容器                   │
│                                                                 │
│  ┌───────────────┐      ┌───────────────┐      ┌──────────────┐ │
│  │   Certbot     │      │ 云服务提供商  │      │   Cron任务   │ │
│  │ SSL证书管理器 │◄────►│ API客户端集群 │      │ 自动证书续期 │ │
│  └───────┬───────┘      └───────┬───────┘      └──────┬───────┘ │
│          │                      │                     │        │
│          ▼                      ▼                     ▼        │
│  ┌───────────────┐      ┌───────────────┐      ┌──────────────┐ │
│  │ 验证方式插件  │      │  证书部署服务  │      │  环境配置   │ │
│  │ DNS/HTTP 挑战 │      │ 高度自定义部署 │      │  .env文件   │ │
│  └───────────────┘      └───────────────┘      └──────────────┘ │
│                                                                 │
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                         外部系统交互                            │
│                                                                 │
│  ┌───────────────┐      ┌───────────────┐      ┌──────────────┐ │
│  │  Let's Encrypt│      │ 多云服务提供商│      │  宿主机系统  │ │
│  │   证书颁发机构│◄────►│    DNS/API    │      │ 脚本和Webhook│ │
│  └───────────────┘      └───────────────┘      └──────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 系统组件

1. **Certbot**: Let's Encrypt 官方提供的证书申请和管理工具
2. **云服务提供商 API 客户端**:
   - 阿里云 CLI 和 SDK
   - 腾讯云 CLI 和 SDK
   - （可扩展其他云服务商）
3. **验证方式插件**:
   - DNS-01 验证插件（支持不同云服务商）
   - HTTP-01 验证插件
4. **证书部署服务**: 管理证书文件的高度可定制部署流程
5. **Cron 任务**: 定时执行证书续期任务
6. **环境配置**: 系统运行所需的配置参数和环境变量

## 工作流程

1. **初始化**: 
   - 读取环境变量或 .env 文件中的配置
   - 根据配置选择验证方式和云服务提供商
   - 设置相应云服务商的访问凭证

2. **选择验证方式**:
   - **DNS-01 验证**:
     - 选择对应云服务商的 DNS 插件
     - 通过云服务商 API 添加 DNS TXT 记录
     - 验证完成后清理 DNS 记录
   - **HTTP-01 验证**:
     - 使用 HTTP 插件在指定 webroot 创建验证文件
     - 验证完成后清理验证文件

3. **证书管理**:
   - 根据域名列表生成证书请求参数
   - 使用 Certbot 申请/续期证书
   - 验证成功后接收证书

4. **证书部署**:
   - 根据配置将证书文件复制到指定目录
   - 可选为每个域名创建单独目录
   - 可选生成证书元数据文件
   - 可选执行宿主机脚本进行后续操作
   - 可选发送 Webhook 通知

5. **自动化管理**:
   - 根据配置使用 Cron 任务定期检查和续期证书
   - 提供容器运行模式选项（持续运行或完成后退出）

## 系统特性

1. **多提供商支持**:
   - 通过插件架构支持多种云服务提供商
   - 统一的接口使添加新提供商变得简单

2. **多验证方式**:
   - DNS-01 验证（支持通配符证书）
   - HTTP-01 验证（适用于 Web 服务器场景）

3. **高度自定义**:
   - 支持自定义验证钩子
   - 支持自定义清理钩子
   - 支持自定义部署钩子
   - 多种证书输出配置选项

4. **CI/CD 友好**:
   - 支持自动模式和手动模式
   - 灵活的容器运行选项
   - 详细日志输出
   - 支持 Webhook 通知

## 技术栈

1. **容器化**: 使用 Docker 提供隔离的运行环境
2. **脚本语言**: 主要使用 Bash 脚本实现主要功能
3. **API 集成**: 使用不同云服务商的 CLI 和 SDK
4. **定时任务**: 使用 Cron 实现证书自动续期
5. **卷映射**: 使用 Docker 卷映射持久化证书和配置
6. **钩子机制**: 基于 Certbot 的钩子机制实现验证和部署定制

## 扩展点

1. **新云服务提供商**: 通过添加新的 DNS 验证插件支持其他云服务提供商
2. **新验证方式**: 可添加其他 ACME 验证方式插件
3. **部署集成**: 通过自定义部署钩子集成各种部署场景
4. **通知机制**: 通过 Webhook 和自定义脚本支持多种通知方式
5. **运行模式**: 支持持续运行和一次性执行两种模式，适应不同场景 